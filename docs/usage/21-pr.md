# 10. `pr` 命令

### 10.1 `yx pr list`

```bash
yx pr list [options]

--org <organizationId>
--repo <projectIds>         # 多个逗号分隔
--author-ids <ids>
--reviewer-ids <ids>
--state <opened|merged|closed>
--search <keyword>
--page <number>
--per-page <number>
--order-by <created_at|updated_at>  # 默认 updated_at
--sort <asc|desc>                   # 默认 desc
--format <table|tsv|json>           # 默认 table
--out <path>                        # 输出到文件（需 --format tsv/json 或 --json）
--json
```

OpenAPI 对应：

- `GET /oapi/v1/codeup/organizations/{organizationId}/changeRequests`

补充：

- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.2 `yx pr view`

```bash
yx pr view <repositoryId> <localId> [options]

--org <organizationId>
--comments
--comments-state <opened|draft|all>
--comments-limit <number>      # 默认 200
--web
--format <table|tsv|json>      # 默认 table
--out <path>                   # 输出到文件（需 --format tsv/json 或 --json）
--json
```

OpenAPI 对应：

- `GET /oapi/v1/codeup/organizations/{organizationId}/repositories/{repositoryId}/changeRequests/{localId}`

补充：

- `--web` 会直接打开 PR 页面（类似 `gh pr view --web`）
- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.3 `yx pr create`

```bash
yx pr create \
  [--repo <repositoryId>] \
  --title <title> \
  --source <branch> \
  --target <branch> \
  [--org <organizationId>] \
  [--description <text>] \
  [--reviewer <userId>]... \
  [--work-item <id>]... \
  [--source-project-id <id>] \
  [--target-project-id <id>] \
  [--ai-review] \
  [--format <table|tsv|json>] \
  [--out <path>] \
  [--json]
```

OpenAPI 对应：

- `POST /oapi/v1/codeup/organizations/{organizationId}/repositories/{repositoryId}/changeRequests`

实现细节：

- `--repo` 可省略；若已配置 `defaults.repositoryId` 会自动使用默认仓库
- 如果未显式传 `--source-project-id` / `--target-project-id`，CLI 会尝试自动推断：
  - 若 `repositoryId` 为纯数字，直接使用该值
  - 否则先请求 repository 详情读取 `id`
- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.3.1 `yx pr edit`（gh 风格）

```bash
yx pr edit <repositoryId> <localId> [options]

--org <organizationId>
--title <title>
-b, --body <text>
-F, --body-file <path>
--description <text>      # --body 别名
--base <branch>           # 目标分支（gh --base 语义）
--reviewer <userId>...         # 设置评审人列表（覆盖式）
--add-reviewer <userId>...     # 追加评审人
--remove-reviewer <userId>...  # 移除评审人
--format <table|tsv|json>      # 默认 table
--out <path>                   # 输出到文件（需 --format tsv/json 或 --json）
--json
```

实现细节：

- 标题/描述/目标分支更新参考官方 SDK `UpdateMergeRequest` 接口
- 评审人更新参考官方 SDK `UpdateMergeRequestPersonnel` 接口
- `--reviewer` 与 `--add-reviewer/--remove-reviewer` 互斥
- 云效网关版本存在差异时，CLI 会自动按候选路径回退尝试
- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.4 `yx pr status`（gh 风格）

```bash
yx pr status [options]

--org <organizationId>
--repo <projectIds>       # 可选，多个逗号分隔
-L, --limit <number>      # 每个分组默认 20
--format <table|tsv|json> # 默认 table
--out <path>              # 输出到文件（需 --format tsv/json 或 --json）
--json
```

功能：

- 基于当前用户输出两组开启中的 PR：
  - authored（我创建）
  - reviewRequested（需要我评审）
- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.5 `yx pr checkout`（gh 风格）

```bash
yx pr checkout <repositoryId> <localId> [options]

--org <organizationId>
--repo-dir <path>         # 默认当前目录
--remote <name>           # 默认 origin
--branch <name>           # 默认 pr/<localId>
--detach
--dry-run
--format <table|tsv|json> # 默认 table
--out <path>              # 输出到文件（需 --format tsv/json 或 --json）
--json
```

实现细节：

- 先查询 PR 详情获取源分支
- 然后执行本地 git 命令：
  - `git fetch <remote> <sourceBranch>`
  - `git checkout -B <branch> FETCH_HEAD`（或 `--detach`）
- `--dry-run` 仅打印将执行的命令，不执行
- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.6 `yx pr merge`（gh 风格）

```bash
yx pr merge <repositoryId> <localId> [options]

--org <organizationId>
--merge-message <text>
--method <ff-only|no-fast-forward|squash|rebase>   # 默认 no-fast-forward
--delete-branch
--format <table|tsv|json>                           # 默认 table
--out <path>                                        # 输出到文件（需 --format tsv/json 或 --json）
--json
```

OpenAPI 对应：

- `POST /oapi/v1/codeup/organizations/{organizationId}/repositories/{repositoryId}/changeRequests/{localId}/merge`

补充：

- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.7 `yx pr close` / `yx pr reopen`

```bash
# 关闭 PR
yx pr close <repositoryId> <localId> [--org <organizationId>] [--format <table|tsv|json>] [--out <path>] [--json]

# 重新打开 PR
yx pr reopen <repositoryId> <localId> [--org <organizationId>] [--format <table|tsv|json>] [--out <path>] [--json]
```

OpenAPI 对应：

- `POST /oapi/v1/codeup/organizations/{organizationId}/repositories/{repositoryId}/changeRequests/{localId}/close`
- `POST /oapi/v1/codeup/organizations/{organizationId}/repositories/{repositoryId}/changeRequests/{localId}/reopen`

补充：

- 支持 `--format` 控制输出格式；机器消费建议显式 `--json` 或 `--format json`
- 支持 `--out` 将 `tsv/json` 结果写入文件

### 10.8 `yx pr comment`（gh 风格）

```bash
yx pr comment <repositoryId> <localId> [options]

--org <organizationId>
-b, --body <text>
-F, --body-file <path>
--inline
--file <path>                 # inline 评论目标文件
--line <number>               # inline 评论目标行号
--patchset <patchsetBizId>
--from <patchsetBizId>        # inline from patchset
--to <patchsetBizId>          # inline to patchset
--reply-to <commentBizId>
--draft
--format <table|tsv|json>     # 输出格式，默认 table
--out <path>                  # 将输出写入文件（仅支持 tsv/json）
--json
```

实现细节：

- 默认发送全局评论（GLOBAL_COMMENT）
- 使用 `--inline` 时发送行级评论（INLINE_COMMENT），需要同时提供 `--file` 与 `--line`
- 如果不传 `--patchset`，CLI 会自动查询当前 PR 的 patchset 列表并优先使用最新版本
- inline 评论若不显式传 `--from/--to`，CLI 会自动推导 patchset 对比区间
- `--reply-to` 可作为回复某条评论的父评论 ID
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.9 `yx pr ready`（gh 风格）

```bash
yx pr ready <repositoryId> <localId> [options]

--org <organizationId>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 将 PR 标记为 “ready for review”
- 考虑云效网关版本差异，CLI 会按多组候选接口做自动回退
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.10 `yx pr checks`（gh 风格）

```bash
yx pr checks <repositoryId> <localId> [options]

--org <organizationId>
--watch
--interval <seconds>      # 默认 5
--timeout <seconds>       # 默认 1800
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 汇总 PR 当前检查状态（pass/fail/pending）
- 优先基于 `ListCheckRuns` 与 `ListCommitStatuses`（按 PR 源分支/commit 推断）汇总，再补充 PR 详情内字段
- `--watch` 时会持续轮询直到没有 pending（或超时）
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11 `yx pr comments`（gh 风格）

```bash
yx pr comments <repositoryId> <localId> [options]

--org <organizationId>
--type <all|global|inline>      # 默认 all
--state <opened|draft|all>      # 默认 opened
--file <path>                    # inline 评论按文件过滤
--summary                        # 仅输出汇总信息
--resolved                       # 仅已解决评论
--format <table|tsv|json>        # 输出格式，默认 table
--out <path>                     # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 查询 PR 评论列表，支持按评论类型和评论状态筛选
- `--summary` 返回聚合统计（类型/状态/resolved/reply/文件分布）
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.1 `yx pr comment-reply`

```bash
yx pr comment-reply <repositoryId> <localId> <commentBizId> [options]

--org <organizationId>
-b, --body <text>
-F, --body-file <path>
--patchset <patchsetBizId>
--draft
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 快捷回复指定 PR 评论（`<commentBizId>`）。
- 默认自动解析最新 patchset，也可用 `--patchset` 显式指定。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.2 `yx pr comment-edit`

```bash
yx pr comment-edit <repositoryId> <localId> <commentBizId> [options]

--org <organizationId>
-b, --body <text>
-F, --body-file <path>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 编辑指定 PR 评论内容（按 `commentBizId`）。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.3 `yx pr comment-delete`

```bash
yx pr comment-delete <repositoryId> <localId> <commentBizId> [options]

--org <organizationId>
--yes
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 删除指定 PR 评论（按 `commentBizId`）。
- 为防误操作，必须显式传 `--yes`。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.4 `yx pr comment-resolve`

```bash
yx pr comment-resolve <repositoryId> <localId> <commentBizId> [options]

--org <organizationId>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 将指定 PR 评论标记为已解决（resolved）。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.5 `yx pr comment-unresolve`

```bash
yx pr comment-unresolve <repositoryId> <localId> <commentBizId> [options]

--org <organizationId>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 将指定 PR 评论恢复为未解决（unresolved）。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.11.6 `yx pr threads`

```bash
yx pr threads <repositoryId> <localId> [options]

--org <organizationId>
--state <opened|draft|all>      # 默认 opened
--file <path>                    # 按文件过滤线程
--author <nameOrUserId>          # 按作者过滤，可重复
--mine                           # 仅显示我参与的线程
--with-replies                   # 仅显示有回复的线程
--since <isoDatetime>            # 仅显示该时间之后有活动的线程（ISO-8601）
--contains <keyword>             # 按评论内容关键字过滤，可重复（AND）
--sort <latest|oldest>           # 排序方式，默认 latest
--all                            # 包含已解决线程
-L, --limit <number>             # 最多显示线程数，默认 200
--ids-only                       # 仅输出线程核心标识字段
--format <table|tsv|json>        # 输出格式，默认 table
--out <path>                     # 将输出写入文件（仅支持 tsv/json）
--summary                        # 输出线程聚合统计
--json
```

功能：

- 按线程聚合展示 PR 评论（根评论 + 回复）。
- 默认仅显示未解决线程；`--all` 可包含已解决线程。
- `--author` 支持按作者名/用户名/userId 过滤线程（匹配线程参与者）。
- `--mine` 自动按当前用户过滤线程（等价附加当前 userId 到 `--author`）。
- `--with-replies` 仅保留至少有一条回复的线程。
- `--since` 按线程最后活动时间过滤（例如 `2026-02-27T00:00:00Z`）。
- `--contains` 按线程内评论内容关键字过滤（可重复，多个关键字需同时命中）。
- `--sort` 支持 `latest`（最近活动优先）和 `oldest`（最早活动优先）。
- `--limit` 限制线程输出数量（`--summary` 时忽略该限制）。
- `--ids-only` 输出精简结构（`threadId/rootCommentBizId/commentBizIds` 等），便于脚本串联 `comment-resolve/comment-unresolve`。
- `--format` 支持 `table`（默认）、`tsv`（适合 shell 管道）和 `json`（等价 `--json`）。
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）。
- `--summary` 输出线程级统计（open/resolved/type/state/file 分布）。

### 10.12 `yx pr patchsets`（gh 风格）

```bash
yx pr patchsets <repositoryId> <localId> [options]

--org <organizationId>
--format <table|tsv|json>      # 输出格式，默认 table
--out <path>                   # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 列出 PR patchset 列表（含 `id`、`version`、`type`、`createdAt`、`commitId`）。
- 返回 CLI 自动推导的建议对比区间（`suggestedRange.fromPatchSetBizId` / `toPatchSetBizId`），可直接用于 `yx pr diff --from/--to`。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）。
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）。

### 10.13 `yx pr files`（gh 风格）

```bash
yx pr files <repositoryId> <localId> [options]

--org <organizationId>
--from <patchsetBizId>
--to <patchsetBizId>
--tree
--stat
-L, --limit <number>            # 默认 200
--format <table|tsv|json>       # 输出格式，默认 table
--out <path>                    # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 输出 PR 变更文件列表（默认仅路径）。
- 加 `--stat` 输出每个文件的增删行统计。
- 加 `--tree` 以目录树形式输出变更文件。
- 支持 `--from/--to` 显式指定 patchset 对比范围。
- `--tree` 与 `--stat` 互斥。
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）。
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）。

### 10.14 `yx pr diff`（gh 风格）

```bash
yx pr diff <repositoryId> <localId> [options]

--org <organizationId>
--from <patchsetBizId>
--to <patchsetBizId>
--file <path>                 # 可重复，按文件路径筛选
--name-only
--files
--stat
--patch
--save <path>                 # 仅与 --patch 一起使用，保存补丁到文件
-L, --limit <number>          # 默认 200
--format <table|tsv|json>     # 输出格式，默认 table
--out <path>                  # 将输出写入文件（仅支持 tsv/json）
--json
```

实现细节：

- 若不传 `--from/--to`，CLI 会自动从 patchset 列表推断最新对比区间
- 默认输出变更文件统计摘要；`--name-only/--files` 仅输出文件路径
- `--stat` 输出文本格式文件级增删统计
- `--patch` 输出统一 diff 补丁内容（基于 compare 接口）
- `--patch --save <path>` 可将补丁直接写入本地文件
- `--patch` 与 `--name-only/--files/--stat` 互斥
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.15 `yx pr review`（gh 风格）

```bash
yx pr review <repositoryId> <localId> [options]

--org <organizationId>
-b, --body <text>
-F, --body-file <path>
--approve
--request-changes
--comment
--opinion <rawOpinion>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

实现细节：

- `--approve` / `--request-changes` / `--comment` 互斥
- 如果云效网关的评审意见枚举存在差异，CLI 会自动按候选意见值回退尝试
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

### 10.16 `yx pr reviews`（gh 风格）

```bash
yx pr reviews <repositoryId> <localId> [options]

--org <organizationId>
--format <table|tsv|json> # 输出格式，默认 table
--out <path>              # 将输出写入文件（仅支持 tsv/json）
--json
```

功能：

- 输出评审人状态汇总（approved / changes_requested / commented / pending）
- `--format` 支持 `table`（默认）、`tsv`（适合脚本）和 `json`（等价 `--json`）
- `--out` 将结果写入文件；需配合 `--format tsv|json`（或直接 `--json`）

---
